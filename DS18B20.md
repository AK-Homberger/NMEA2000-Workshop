# NMEA2000-Thermometer mit DS18B20

Der DS18B20 ist ein Temperatur-Sensor mit einem Messbereich von -55 Grad bis +125 Grad und wird über 1-Wire angeschlossen.

Der BME280 eignet sich gut, um Lufttemperaturen zu messen. Für andere Aufgaben, wie zum Beispiel der Messung der Temperatur am Abgaskrümmer, ist er nicht geeignet. Hierfür eignet sich besser ein DS18B2 mit einem in der [Metallhülle vergossenem Sensor](https://www.reichelt.de/shelly-temperatur-sensor-ds18b20-shelly-ds18b20-p287127.html?&nbc=1).

# Aufbau auf dem Steckbrett
Für das Beispiel mit dem DS18B20 ist das Basis-Steckbrett mit dem Bauteil (hier die transistorähnliche Steckversion) zu erweitern. Das sollte dann so aussehen:

![Steckbrett mit DS18B20](https://github.com/AK-Homberger/NMEA-Workshop/blob/main/Bilder/NMEA2000-DS18B20_Steckplatine.png)

Wir nutzen den DS18B20 mit dem 1-Wire-Bus. Dazu ist 3,3 Volt, GND und Signal (GPIO 13) zu verbinden.
Zusätzlich muss ein Pull-Up-Widerstand von 4700 Ohm zwischen 3,3 Volt und Signal (GPIO 13) eingesetzt werden. Wenn gerade kein 4K7 Ohm Widerstand zur Verfügung steht, dann geht auch das 10K Ohm Potentiometer (die beiden äusseren Pins).

# Installieren der DallasTemperature-Bibliothek

Über den Arduino-IDE Bibliotheksverwalter installieren wir die Bibliothek "DallasTemperature". Das geht wieder mit "Sketch", "Bibliothek einbinden", "Bibliotheken verwalten...". Dann "Dallas" im Suchfeld eintragen und die angezeigte Bibliothek "DallasTemperature" installieren.

# Laden des Beispielprogramms

Nun laden wir das neu Beispielprogramm "NMEA200-DS18B20.ino" in die Arduino-IDE. Nach dem Hochladen auf den rechten ESP32 sollte der NMEA-Reader ein jetzt schon vertrautes Bild zeigen:

![NMEA-Reader-4](https://github.com/AK-Homberger/NMEA-Workshop/blob/main/Bilder/NMEAReader-4.png)

Die Temperatur wird wieder mit dem PGN130312 gesendet und angezeigt.

Doch wo liegen die Unterschiede zur Temperaturanzeige mit dem BME280?

1. Anstatt einem I2C-Bus nutzen wir mit dem DS18B2 einen 1-Wire-Bus
2. Das Auslesen des Sensors per 1-Wire kann bis zu 100 ms daueren. Wir hatten aber schon gelernt, dass es keine gute Idee ist, die loop()-Ausführung so lange zu erzögern.
3. Daher nutzen wir die Multi-Tasking-Fähigkeit des ESP32 und erstellen die Lesefunktion als eigene isolierte Task, die Funktioniert, ohne loop() stark zu beeinträchtigen.

Hier kommen die notwendigen Änderungen zum ersten Beispielprogramm:


# 1. Include-Dateien

Statt der Dateien für den BME280 benötigen wir nun die Informationen für das verwendete DS18B20-Modul:

```
// Include file for DS18B20
#include <DallasTemperature.h>
```

# 2. Definitionen und Variablen für den DS18B20
Mit den folgen Zeilen zeigen die notwendigen Inormationen 

```
// 1-Wire connection for temperature (Dallas DS18B20) is plugged into GPIO13 on the ESP32
#define ONE_WIRE_BUS 13

// Setup a oneWire instance to communicate with any OneWire devices (not just Maxim/Dallas temperature ICs)
OneWire oneWire(ONE_WIRE_BUS);

// Pass our oneWire reference to Dallas Temperature.
DallasTemperature sensors(&oneWire);

```











